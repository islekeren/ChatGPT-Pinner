document.addEventListener("DOMContentLoaded",()=>{try{let d=function(e){document.body.dataset.theme=e},$=function(){chrome.tabs.query({active:!0,url:"*://chatgpt.com/*"},e=>{if(chrome.runtime.lastError){console.warn("Error querying tabs for theme:",chrome.runtime.lastError.message),d("light");return}if(e&&e.length>0){const r=e[0];chrome.scripting.executeScript({target:{tabId:r.id},func:()=>document.documentElement.classList.contains("dark")?"dark":"light"},t=>{if(chrome.runtime.lastError){console.warn("Error executing script for theme detection:",chrome.runtime.lastError.message),d("light");return}t&&t[0]&&t[0].result?d(t[0].result):d("light")})}else d("light")})},s=function(e){console.error("Popup Error:",e),alert(`An error occurred: ${e}`)},u=function(e){e!=="settings"&&localStorage.setItem("lastActiveTab",e),v.classList.toggle("active",e==="chats"),f.classList.toggle("active",e==="bookmarks"),S.classList.toggle("active",e==="chats"),M.classList.toggle("active",e==="bookmarks"),C.classList.toggle("active",e==="settings"),e==="settings"?(g.innerHTML=T,g.title="Close Settings"):(g.innerHTML=P,g.title="Settings")},h=function(){try{chrome.storage.sync.get(["pinnedChats","bookmarkedChats"],e=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);const r=e.pinnedChats||[],t=e.bookmarkedChats||[],o=r.length>0?` (${r.length})`:"",a=t.length>0?` (${t.length})`:"";if(v.innerHTML=`Pinned${o}`,f.innerHTML=`Bookmarks${a}`,t.length>0){if(y.style.display="none",m.style.display="flex",t.sort((n,c)=>new Date(c.bookmarkedAt)-new Date(n.bookmarkedAt)),m.innerHTML="",t.length>=k-5){const n=document.createElement("div");n.className="limit-notice",n.textContent=`${t.length}/${k} bookmarks used`,m.appendChild(n)}t.forEach(n=>{console.log(n);const c=w(n,"bookmarked");m.appendChild(c)})}else y.style.display="block",m.style.display="none"}catch(r){s(`Error processing bookmarked chats: ${r.message}`),y.style.display="block",m.style.display="none"}try{const r=e&&e.pinnedChats||[];if(r.length>0){if(E.style.display="none",i.style.display="flex",r.sort((t,o)=>new Date(o.pinnedAt)-new Date(t.pinnedAt)),i.innerHTML="",r.length>=p-2){const t=document.createElement("div");t.className="limit-notice",t.textContent=`${r.length}/${p} pins used`,i.appendChild(t)}r.forEach(t=>{const o=w(t,"pinned");i.appendChild(o)})}else E.style.display="block",i.style.display="none"}catch(r){s(`Error processing pinned chats: ${r.message}`),E.style.display="block",i.style.display="none"}})}catch(e){s(`Error loading chats: ${e.message}`)}},w=function(e,r){try{const t=document.createElement("div");t.className="chat-item",t.dataset.chatId=e.id;const o=document.createElement("a");o.className="chat-link",o.href=`https://chatgpt.com/c/${e.id}`,o.textContent=e.name,o.title=e.name,o.target="_blank";const a=document.createElement("div");a.className="button-container";const n=document.createElement("button");n.className="action-button",r==="pinned"?(n.classList.add("bookmark"),n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>',n.title="Move to bookmarks",n.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),I(e.id)})):(n.classList.add("pin"),n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"></path></svg>',n.title="Move to pinned",n.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),B(e.id)}));const c=document.createElement("button");return c.className="unpin-button",c.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.29289 6.29289C6.68342 5.90237 7.31658 5.90237 7.70711 6.29289L12 10.5858L16.2929 6.29289C16.6834 5.90237 17.3166 5.90237 17.7071 6.29289C18.0976 6.68342 18.0976 7.31658 17.7071 7.70711L13.4142 12L17.7071 16.2929C18.0976 16.6834 18.0976 17.3166 17.7071 17.7071C17.3166 18.0976 16.6834 18.0976 16.2929 17.7071L12 13.4142L7.70711 17.7071C7.31658 18.0976 6.68342 18.0976 6.29289 17.7071C5.90237 17.3166 5.90237 16.6834 6.29289 16.2929L10.5858 12L6.29289 7.70711C5.90237 7.31658 5.90237 6.68342 6.29289 6.29289Z" fill="currentColor"/></svg>',c.title=r==="pinned"?"Unpin chat":"Remove bookmark",c.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),r==="pinned"?L(e.id):x(e.id)}),a.appendChild(n),a.appendChild(c),t.appendChild(o),t.appendChild(a),t}catch(t){s(`Error creating chat item for ${e.name}: ${t.message}`);const o=document.createElement("div");return o.className="chat-item",o.textContent="Error displaying this item.",o}},L=function(e){try{chrome.storage.sync.get(["pinnedChats"],r=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);let t=r.pinnedChats||[];t=t.filter(o=>o.id!==e),chrome.storage.sync.set({pinnedChats:t},()=>{if(chrome.runtime.lastError){s(`Error saving unpinned chat: ${chrome.runtime.lastError.message}`);return}h()})}catch(t){s(`Error processing unpin operation: ${t.message}`)}})}catch(r){s(`Error initiating unpin chat: ${r.message}`)}},x=function(e){try{chrome.storage.sync.get(["bookmarkedChats"],r=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);let t=r.bookmarkedChats||[];t=t.filter(o=>o.id!==e),chrome.storage.sync.set({bookmarkedChats:t},()=>{if(chrome.runtime.lastError){s(`Error saving removed bookmark: ${chrome.runtime.lastError.message}`);return}h()})}catch(t){s(`Error processing remove bookmark operation: ${t.message}`)}})}catch(r){s(`Error initiating remove bookmark: ${r.message}`)}},I=function(e){try{chrome.storage.sync.get(["pinnedChats","bookmarkedChats"],r=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);let t=r.pinnedChats||[],o=r.bookmarkedChats||[];if(o.length>=k){alert(`You've reached the maximum limit of ${k} bookmarks. Please remove some before adding more.`);return}const a=t.find(n=>n.id===e);if(!a)return;t=t.filter(n=>n.id!==e),o.push({...a,bookmarkedAt:new Date().toISOString()}),chrome.storage.sync.set({pinnedChats:t,bookmarkedChats:o},()=>{if(chrome.runtime.lastError){s(`Error saving after moving to bookmarks: ${chrome.runtime.lastError.message}`);return}h()})}catch(t){s(`Error processing move to bookmarks: ${t.message}`)}})}catch(r){s(`Error initiating move to bookmarks: ${r.message}`)}},B=function(e){try{chrome.storage.sync.get(["pinnedChats","bookmarkedChats"],r=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);let t=r.pinnedChats||[],o=r.bookmarkedChats||[];if(t.length>=p){alert(`You've reached the maximum limit of ${p} pins. Please remove some before adding more.`);return}const a=o.find(n=>n.id===e);if(!a)return;o=o.filter(n=>n.id!==e),t.push({...a,pinnedAt:new Date().toISOString()}),chrome.storage.sync.set({pinnedChats:t,bookmarkedChats:o},()=>{if(chrome.runtime.lastError){s(`Error saving after moving to pinned: ${chrome.runtime.lastError.message}`);return}h()})}catch(t){s(`Error processing move to pinned: ${t.message}`)}})}catch(r){s(`Error initiating move to pinned: ${r.message}`)}};var A=d,H=$,D=s,V=u,O=h,q=w,z=L,N=x,_=I,G=B;const i=document.getElementById("pinnedChats"),m=document.getElementById("bookmarkedChats"),E=document.getElementById("emptyPinnedState"),y=document.getElementById("emptyBookmarkState"),v=document.getElementById("chatsTab"),f=document.getElementById("bookmarksTab"),S=document.getElementById("chatsPage"),M=document.getElementById("bookmarksPage"),C=document.getElementById("settingsPage"),g=document.getElementById("settingsButton"),b=document.getElementById("showSidebar"),K=document.getElementById("errorDisplay"),P='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',T='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';$();const p=10,k=50;v.addEventListener("click",()=>{try{u("chats")}catch(e){s(`Error switching to chats tab: ${e.message}`)}}),f.addEventListener("click",()=>{try{u("bookmarks")}catch(e){s(`Error switching to bookmarks tab: ${e.message}`)}}),g.addEventListener("click",()=>{try{if(C.classList.contains("active")){const e=localStorage.getItem("lastActiveTab")||"bookmarks";u(e)}else u("settings")}catch(e){s(`Error toggling settings: ${e.message}`)}}),chrome.storage.sync.get(["showPinnedInSidebar"],e=>{try{if(chrome.runtime.lastError)throw new Error(chrome.runtime.lastError.message);b.checked=e.showPinnedInSidebar!==!1}catch(r){s(`Error initializing settings: ${r.message}`)}}),b.addEventListener("change",()=>{try{chrome.storage.sync.set({showPinnedInSidebar:b.checked},()=>{if(chrome.runtime.lastError){s(`Error saving settings: ${chrome.runtime.lastError.message}`);return}chrome.tabs.query({url:"*://chatgpt.com/*"},e=>{if(chrome.runtime.lastError){s(`Error querying tabs: ${chrome.runtime.lastError.message}`);return}e.forEach(r=>{chrome.scripting.executeScript({target:{tabId:r.id},func:()=>window.location.reload()},()=>{chrome.runtime.lastError&&console.warn(`Error reloading tab ${r.id}: ${chrome.runtime.lastError.message}`)})})})})}catch(e){s(`Error handling sidebar setting change: ${e.message}`)}}),h()}catch(i){console.error("Fatal Popup Error:",i),alert(`A critical error occurred in the extension popup: ${i.message}. Please try reloading the popup or the page.`)}});
